[Threat - RR - USB Insertion with 1st time seen Serial Number - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - USB Insertion with 1st time seen Serial Number - Combined
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 7 * * * *
schedule_window = 5
description = Attribute Risk to both Users and Systems when a USB insertion with a never before seen Serial Number is seen for the very first time.  Uses OSQuery as a datasource.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index="botsv2" sourcetype=osquery_results  TERM(USB) name="pack_hardware-monitoring_usb_devices" action="added"\
|eval rule_attack_tactic_technique=\
"initial_access - T1200 - Hardware Additions - https://attack.mitre.org/techniques/T1200/\
|initial_access - T1091 - Replication Through Removable Media - https://attack.mitre.org/techniques/T1091/\
|lateral_movement - T1091 - Data from Removable Media - https://attack.mitre.org/techniques/T1025/\
|collection - T1025 - Replication Through Removable Media - https://attack.mitre.org/techniques/T1091/\
|exfiltration - T1052 - Exfiltration Over Physical Medium - https://attack.mitre.org/techniques/T1052/\
|command_and_control - T1092 - Communication Through Removable Media - https://attack.mitre.org/techniques/T1092/"\
|table _time host columns.serial columns.vendor_id user* src_asset_tag dest_asset_tag user_priority rule* src*\
|eventstats earliest_time(_time) as ET by columns.serial\
|eval firstSeen=strftime(ET,"%T %D")\
|where ET > relative_time(1501762500, "-1h@h" )\
|stats values(*) as * by host,columns.serial\
|eval risk_message="USB Insertion with 1st time seen serial number (".'columns.serial'."). Vendor=".'columns.vendor_id'\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,host,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - USB Insertion with 1st time seen Vendor ID - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - USB Insertion with 1st time seen Vendor ID - Combined
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 9 * * * *
schedule_window = 5
description = Attribute Risk to both Users and Systems when a USB insertion with a never before seen Vendor ID is seen for the very first time.  Uses OSQuery as a datasource.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index="botsv2" sourcetype=osquery_results  TERM(USB) name="pack_hardware-monitoring_usb_devices" action="added"\
|eval rule_attack_tactic_technique=\
"initial_access - T1200 - Hardware Additions - https://attack.mitre.org/techniques/T1200/\
|initial_access - T1091 - Replication Through Removable Media - https://attack.mitre.org/techniques/T1091/\
|lateral_movement - T1091 - Data from Removable Media - https://attack.mitre.org/techniques/T1025/\
|collection - T1025 - Replication Through Removable Media - https://attack.mitre.org/techniques/T1091/\
|exfiltration - T1052 - Exfiltration Over Physical Medium - https://attack.mitre.org/techniques/T1052/\
|command_and_control - T1092 - Communication Through Removable Media - https://attack.mitre.org/techniques/T1092/"\
|table _time host columns.serial columns.vendor_id user* src_asset_tag dest_asset_tag user_priority rule* src*\
|eventstats earliest_time(_time) as ET by columns.vendor_id\
|eval firstSeen=strftime(ET,"%T %D")\
|where ET > relative_time(1501762500, "-1h@h" )\
|stats values(*) as * by host,columns.vendor_id\
|eval risk_message="USB Insertion with 1st time seen Vendor ID (".'columns.vendor_id'."). Serial number=".'columns.serial'\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,host,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[TEST]
action.email.useNSSubject = 1
action.keyindicator.invert = 0
action.logevent.command = sendalert $action_name$ results_file="$results.file$" results_link="$results.url$"
action.logevent.description = Send log event to Splunk receiver endpoint
action.logevent.forceCsvResults = auto
action.logevent.icon_path = logevent.png
action.logevent.is_custom = 1
action.logevent.label = Log Event
action.logevent.maxresults = 10000
action.logevent.maxtime = 5m
action.logevent.param.index = main
action.logevent.param.source = alert:$name$
action.logevent.param.sourcetype = generic_single_line
action.logevent.payload_format = json
action.logevent.track_alert = 0
action.logevent.ttl = 10p
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.command = sendalert $action_name$ results_file="$results.file$" results_link="$results.url$"
action.webhook.description = Generic HTTP POST to a specified URL
action.webhook.forceCsvResults = auto
action.webhook.icon_path = webhook.png
action.webhook.is_custom = 1
action.webhook.label = Webhook
action.webhook.maxresults = 10000
action.webhook.maxtime = 5m
action.webhook.param.user_agent = Splunk/$server.guid$
action.webhook.payload_format = json
action.webhook.track_alert = 0
action.webhook.ttl = 10p
alert.track = 0
dispatch.earliest_time = -1000d
dispatch.latest_time = -1d
display.general.timeRangePicker.show = 0
display.page.search.mode = verbose
search = | from datamodel:"Authentication"."Authentication" | search user=$user$

[All Tactics by Asset]
action.swimlane = 1
action.swimlane.constraint_fields = risk_object
action.swimlane.constraint_method = reverse_asset_lookup
action.swimlane.drilldown_search = index=risk risk_object=kutekitten source="Threat*"|makemv delim="|" rule_attack_tactic_technique
action.swimlane.title = Observed ATT&CK Tactics
search = index=risk risk_object=kutekitten source="Threat*"|makemv delim="|" rule_attack_tactic_technique\
|mvexpand rule_attack_tactic_technique\
|rex field=rule_attack_tactic_technique "(^|\|)(?<tactic>.+?) - (?<tactic_num>.+?) - (?<technique>.+?) - (?<technique_ref>.*)"\
|stats values(tactic) as Tactic values(risk_object) as risk_object count sum(risk_score) as risk_score  by _time

[All Techniques by Asset]
action.swimlane = 1
action.swimlane.constraint_fields = risk_object
action.swimlane.constraint_method = reverse_asset_lookup
action.swimlane.drilldown_search = index=risk risk_object=kutekitten source="Threat*"
action.swimlane.title = Observed ATT&CK Techniques
search = index=risk risk_object=kutekitten source="Threat*"|makemv delim="|" rule_attack_tactic_technique\
|mvexpand rule_attack_tactic_technique\
|rex field=rule_attack_tactic_technique "(^|\|)(?<tactic>.+?) - (?<tactic_num>.+?) - (?<technique>.+?) - (?<technique_ref>.*)"\
|stats values(technique) as Technique values(risk_object) as risk_object count sum(risk_score) as risk_score  by _time

[Threat - RR - DDNS Activity Detected - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - DDNS Activity Detected - System
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 11 * * * *
schedule_window = 5
description = DDNS is often used by malicious players, we need to be on the lookout for this.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | from datamodel:Network_Resolution.DNS | search _time < 1501848000 record_type="A" `Exclude_DNS_Server_src_ip` | eval list="iana" | `ut_parse(query,list)` | fields ut_domain,src,query | bucket _time span=5m | stats count by ut_domain,query,src _time | lookup DDNS_lookup domain as ut_domain | search provider=* \
|eval rule_attack_tactic_technique=\
"establish_and_maintain_infrastructure - T1333 - Dynamic DNS - https://attack.mitre.org/techniques/T1333/\
|command_and_control - T1071 - Standard Application Layer Protocol - https://attack.mitre.org/techniques/T1071/\
|adversary_opsec - T1311 - Dynamic DNS - https://attack.mitre.org/techniques/T1311/" \
|lookup dhcpLogs dest_ip as src OUTPUT dest_nt_host as host\
|eval risk_message="DDNS activity detected (".ut_domain.") via query=".query." and provider=".provider \
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low" \
`risk_score_system(impact,confidence,host,src_category,src_priority)`

[Threat - RR - DNS Activity to External IP Detected - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - DNS Activity to External IP Detected - System
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk = 0
action.risk.param._risk_object = host
action.risk.param._risk_object_type = system
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 13 * * * *
schedule_window = 5
description = Adversaries may communicate over a commonly used port to bypass firewalls or network detection systems and to blend with normal network activity to avoid more detailed inspection.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
display.page.search.mode = verbose
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | tstats `summariesonly` count from datamodel=Network_Traffic where All_Traffic.dest_port=53 All_Traffic.src_ip!="10.0.1.100" All_Traffic.dest_ip!="10.0.1.100" All_Traffic.dest_ip!="8.8.8.8" All_Traffic.dest_ip!="4.4.4.4" All_Traffic.dest_ip!="172.31.0.2" by All_Traffic.dest_ip All_Traffic.src_ip\
|rename All_Traffic.dest_ip AS dest_ip All_Traffic.src_ip AS src_ip\
|rename category as src_category priority as src_priority\
|lookup frothly_assets ip as src_ip\
|eval rule_attack_tactic_technique="command_and_control -  T1043 - Commonly Used Port - https://attack.mitre.org/techniques/T1043/" \
|eval risk_message="Prohibited DNS activity to external IP (".dest_ip.") by system=".nt_host\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,nt_host,src_category,src_priority)`

[Threat - RR - Process Discrepancy Detected - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Process Discrepancy Detected - System
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 15 * * * *
schedule_window = 5
description = Masquerading occurs when the name or location of an executable, legitimate or malicious, is manipulated or abused for the sake of evading defenses and observation. Several different variations of this technique have been observed. One variant is for an executable to be placed in a commonly trusted directory or given the name of a legitimate, trusted program. Alternatively, the filename given may be a close approximation of legitimate programs. This is done to bypass tools that trust executables by relying on file name or path, as well as to deceive defenders and system administrators into thinking a file is benign by associating the name with something that is thought to be legitimate.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv2 sourcetype=osquery_results columns.cwd="/Users*" \
| rename columns.name as name, columns.cmdline as cmdline\
| eval dest=host, result=if(like(cmdline,"%".name."%"),"Normal","Evil") \
| table _time dest result name cmdline \
|search result="Evil"\
|eval rule_attack_tactic_technique="defense_evasion - T1036 - Masquerading - https://attack.mitre.org/techniques/T1036/"\
|eval risk_message="Process Discrepancy (".cmdline." as ".name.") on system=".dest\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,dest,dest_category,dest_priority)`

[Threat - RR - Prohibited Process Detected - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Prohibited Process Detected - System
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 17 * * * *
schedule_window = 5
description = An adversary may stage software and tools for use during later stages of an attack. The software and tools may be placed on systems legitimately in use by the adversary or may be placed on previously compromised infrastructure.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | from datamodel:"Endpoint"."Processes" \
|search _time < 1501848000\
|bin span=1h _time\
|lookup interesting_processes_lookup app as process,dest OUTPUTNEW is_required,is_prohibited,is_secure,note \
| fillnull value="undefined" is_required,is_prohibited,is_secure \
|`lower(is_required)` \
|`lower(is_prohibited)` \
|`lower(is_secure)` \
| search is_prohibited=true \
| fields + _time,event_hash,_raw,dest,process,note,dest_category,dest_priority\
|stats count min(_time) as _time values(dest_category) as dest_category values(dest_priority) as dest_priority by dest,process,note\
|eval _time=strftime(_time,"%F %T")\
|eval rule_attack_tactic_technique="defense_evasion - T1036 - Masquerading - https://attack.mitre.org/techniques/T1036/|stage_capabilities - T1362 - Upload, install, and configure software/tools - https://attack.mitre.org/techniques/T1362/"\
|eval risk_message="Prohibited Process Detected (".process.") on host=".dest \
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,dest,dest_category,dest_priority)`

[Threat - RR - Threat Intel Match on DNS Domain request - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Threat Intel Match on DNS Domain request - System
action.customsearchbuilder.spec = {}
action.keyindicator.invert = 0
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.rba.param.verbose = 0
action.risk.param.verbose = 0
action.threat_add.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 19 * * * *
schedule_window = 5
description = Threat Intelligence match discovered for a DNS request.  The source for the intel is local_domain_intel.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | from datamodel:Network_Resolution.DNS | search _time < 1501848001 record_type="A" `Exclude_DNS_Server_src_ip` | eval list="iana" | `ut_parse(query,list)` | fields ut_domain,src,query | bucket _time span=5m | stats count as queryCount by query,ut_domain,src _time | lookup local_domain_intel domain as ut_domain OUTPUT description | search description=* | lookup dhcpLogs dest_ip as src OUTPUT dest_nt_host as host\
|eval risk_message="DNS request to locally sourced domain IOC (".ut_domain."). Query=".query.". Threat Intel Desc=".description \
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,host,src_category,src_priority)`

[Threat - RR - DNS Query For Potential DGA Domain - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - DNS Query For Potential DGA Domain - System
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 21 * * * *
schedule_window = 5
description = A DNS query was made to a domain that is suspicious based on having high entropy and a low standard deviation.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = | tstats summariesonly=true count max(_time) as _time from datamodel=Network_Resolution.DNS where DNS.record_type=A DNS.src="10.*"  by DNS.query, DNS.src \
| `drop_dm_object_name("DNS")` \
| eval list="*" \
| `ut_parse_extended(query,list)` \
| lookup dns_exclusions.csv domain AS ut_domain OUTPUT domain \
| search NOT(ut_domain="None" OR domain=*) \
| lookup alexa_lookup_by_str domain AS ut_domain \
| search NOT(rank=*) \
| `ut_shannon(ut_subdomain)` \
| eval subdomain_length = length(ut_subdomain) \
| stats count(ut_subdomain) as count avg(ut_shannon) as avg_sha stdev(ut_shannon) as stdev_sha avg(subdomain_length) as avg_sublen stdev(subdomain_length) as stdev_sublen, values(src) as src, values(query) as query, max(_time) as _time by ut_domain \
| eval avg_sha = round(avg_sha, 1) \
| eval avg_sublen = round(avg_sublen, 1) \
| eval stdev_sha = round(stdev_sha, 2) \
| eval stdev_sublen = round(stdev_sublen, 1) \
| where avg_sha > 3 AND avg_sublen > 20 AND stdev_sublen < .5 and count > 1  \
\
| mvexpand query\
| mvexpand src\
| where src!="10.0.1.100"\
| rename src as src_ip, ut_domain as dest_system\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_system\
        ]\
| eval src_system=coalesce(src_system,src_ip)\
\
|eval rule_attack_tactic_technique=\
"command_and_control - T1483 - Domain Generation Algorithms - https://attack.mitre.org/techniques/T1483/" \
\
|eval risk_message="A DNS query was made to a domain (".query.") that is suspicious based on having high entropy and a low standard deviation."\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_system(impact,confidence,dest_system,src_category,src_priority)`

[Threat - RR - Intrusion Detection Event - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Intrusion Detection Event - System
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 21 * * * *
schedule_window = 5
description = Intrusion detection events found that may indicate malicious activity in the environment.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = |from datamodel:Intrusion_Detection.IDS_Attacks|search signature!="unknown" (src=TERM(10.0.4.2) OR src=TERM(10.0.2.107) OR src=TERM(10.0.2.109))\
\
|rex field=_raw "dest_ip.:.(?<dest_ip>[^\"]*?)\".*?dest_port.:(?<dest_port>\d+).*payload.:.(?<payload>[^\"]*)\""\
\
|table src,dest_ip,dest_port, payload, signature, severity, user, category,action, _time\
| rename src as src_ip\
|lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
\
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
 \
|eval rule_attack_tactic_technique=case(category="A Network Trojan was detected",\
"command_and_control - T1043 - Commonly Used Port - https://attack.mitre.org/techniques/T1043/\
|command_and_control - T1071 - Standard Application Layer Protocol - https://attack.mitre.org/techniques/T1071/",\
category="Generic Protocol Command Decode",\
"command_and_control - T1132 - Data Encoding - https://attack.mitre.org/techniques/T1132/\
|command_and_control - T1071 - Standard Application Layer Protocol - https://attack.mitre.org/techniques/T1071/"\
)\
\
|eval risk_message="Intrusion alert detected (".signature.") via category=".category." and action=".action\
\
|eval TESTMODE=0\
| eval impact=case(action="allowed","high",action="blocked","low",1=1,"medium")\
| eval confidence=case(severity="critical" OR severity="high","high",severity="medium","medium", severity="low","low",1=1,"medium")\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`

[Threat - RR - Long Network Connection - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Long Network Connection - System
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 23 * * * *
schedule_window = 5
description = Long network connections, excess of 3 hours, may indication an open malicious connection or callback.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = | tstats `summariesonly` count, max(_time) as _time from datamodel=Network_Traffic.All_Traffic where All_Traffic.duration>10800 by All_Traffic.src_ip, All_Traffic.dest_ip, All_Traffic.dest_port, All_Traffic.duration, All_Traffic.dest_zone, sourcetype \
| `drop_dm_object_name("All_Traffic")`\
\
| search (src_ip=TERM(10.0.4.2) OR src_ip=TERM(10.0.2.107) OR src_ip=TERM(10.0.2.109))\
\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| lookup dnslookup clientip as dest_ip OUTPUT clienthost as dest_dns\
| eval dest_system=coalesce(dest_dns,dest_ip) \
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
|eval rule_attack_tactic_technique=\
"command_and_control - T1008 - Fallback Channels - https://attack.mitre.org/techniques/T1008/\
|command_and_control - T1071 - Standard Application Layer Protocol - https://attack.mitre.org/techniques/T1071/" \
\
|eval risk_message="Network connection exceeding 3 hours detected to (".dest_system.") via dest_port=".dest_port\
\
|eval TESTMODE=0\
| eval impact="medium"\
| eval confidence="low"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_system(impact,confidence,dest_system,src_category,src_priority)`\


[Threat - RR - Non-Standard Port Web Traffic - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Non-Standard Port Web Traffic - System
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 25 * * * *
schedule_window = 5
description = This identifies web traffic not over port 80 or 443 from an internal ip to an external ip.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = |from datamodel:Web.Web\
| search src="10.*" dest!="10.*"\
\
| eval list="mozilla" \
| `ut_parse_extended(url,list)`\
| where ut_port!="80" AND ut_port!="443"\
| stats count, max(_time) as _time by url, dest, src, ut_port, sourcetype\
\
| rename src as src_ip, dest as dest_ip\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| lookup dnslookup clientip as dest_ip OUTPUT clienthost as dest_dns\
| eval dest_system=coalesce(dest_dns,dest_ip) \
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
| eval rule_attack_tactic_technique=\
"command_and_control - T1065 - Uncommonly Used Port - https://attack.mitre.org/techniques/T1065/"\
\
| eval risk_message="An http connection was connected over a non-standard port(".dest_port.") to an external source(".dest_system.")."\
\
|eval TESTMODE=0\
| eval impact="medium"\
| eval confidence="low"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_system(impact,confidence,dest_system,src_category,src_priority)`

[Threat - RR - Security Control Disabled - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Security Control Disabled - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 27 * * * *
schedule_window = 5
description = Identifies commands that result in the Windows Firewall being disabled.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = index=botsv2 sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" cmdline="*netsh.exe*" cmdline="*off*"\
| table process, parent_process,dvc_ip,user,cmdline, _time\
\
| rename dvc_ip as src_ip\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
| eval src_user=mvindex(split(user,"\\"),1)\
\
|eval rule_attack_tactic_technique=\
"defense_evasion - T1089 - Disabling Security Tools - https://attack.mitre.org/techniques/T1089/" \
\
|eval risk_message="A command was found disabling a security control."\
\
|eval TESTMODE=0\
| eval impact="high"\
| eval confidence="high"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_user(impact,confidence,src_user)`\


[Threat - RR - Suspicious Developer Utility Command - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious Developer Utility Command - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 29 * * * *
schedule_window = 5
description = A suspicious developer utility, csc.exe, command was found to be executing.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = index=botsv2 sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" cmdline="*csc.exe*/noconfig*"\
| table process, parent_process,dvc_ip,user,cmdline,_time\
\
| rename dvc_ip as src_ip\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
| eval src_user=mvindex(split(user,"\\"),1)\
\
|eval rule_attack_tactic_technique=\
"execution - T1127 - Trusted Developer Utilities - https://attack.mitre.org/techniques/T1127/" \
\
|eval risk_message="A suspicious developer utility, csc.exe, command was found to be executing."\
\
|eval TESTMODE=0\
| eval impact="high"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_user(impact,confidence,src_user)`

[Threat - RR - Suspicious PowerShell Command - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious PowerShell Command - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 31 * * * *
schedule_window = 5
description = Identifies PowerShell running with the -nop flag also set
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = index=botsv2 sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" cmdline="*powershell*-nop*"\
| table process, parent_process,dvc_ip,user,cmdline,_time\
\
| rename dvc_ip as src_ip\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
| eval src_user=mvindex(split(user,"\\"),1)\
\
|eval rule_attack_tactic_technique=\
"execution - T1086 - PowerShell - https://attack.mitre.org/techniques/T1086/" \
\
|eval risk_message="A suspicious PowerShell command was found to be executing."\
\
|eval TESTMODE=0\
| eval impact="high"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_user(impact,confidence,src_user)`

[Threat - RR - Suspicious Scheduled Task - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious Scheduled Task - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 33 * * * *
schedule_window = 5
description = A scheduled task was created with a suspicious hidden window command.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = index=botsv2 sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" process="schtasks.exe" cmdline="*-w hidden*"\
| table process, parent_process,dvc_ip,user,cmdline,_time\
\
| rename dvc_ip as src_ip\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
| eval src_user=mvindex(split(user,"\\"),1)\
\
|eval rule_attack_tactic_technique=\
"persistence - T1053 - Scheduled Task - https://attack.mitre.org/techniques/T1053/" \
\
|eval risk_message="A scheduled task was created with a suspicious hidden window command."\
\
|eval TESTMODE=0\
| eval impact="high"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_user(impact,confidence,src_user)`

[Threat - RR - Suspicious SSL Certificate - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious SSL Certificate - System
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 35 * * * *
schedule_window = 5
description = A potentially invalid or suspicious SSL Certificate was identified.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = | tstats `summariesonly` max(_time) as _time,values(All_Certificates.SSL.ssl_subject) as ssl_subject,values(All_Certificates.SSL.ssl_issuer) as ssl_issuer,values(All_Certificates.SSL.ssl_hash) as ssl_hash,count from datamodel=Certificates.All_Certificates where nodename=All_Certificates.SSL All_Certificates.SSL.ssl_subject!="*CN \=*" All_Certificates.SSL.ssl_subject!="*O \=*" All_Certificates.SSL.ssl_subject!="unknown" by All_Certificates.src,All_Certificates.dest,All_Certificates.SSL.ssl_serial \
| `drop_dm_object_name(All_Certificates)` \
| `drop_dm_object_name(SSL)` \
| sort - count \
| fields _time, src, dest, ssl_subject, ssl_issuer, ssl_serial, ssl_hash, count\
\
| rename src as src_ip, dest as dest_ip\
| lookup dnslookup clientip as dest_ip OUTPUT clienthost as dest_dns\
| eval dest_system=coalesce(dest_dns,dest_ip) \
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
\
|eval rule_attack_tactic_technique=\
"defense_evasion - T1116 - Code Signing - https://attack.mitre.org/techniques/T1116/" \
\
|eval risk_message="A potentially invalid or malicious SSL Certificate was identified Subject=(".ssl_subject.") and Issuer=(".ssl_issuer.")"\
\
|eval TESTMODE=0\
| eval impact="medium"\
| eval confidence="low"\
`risk_score_system("medium","low",src_system,src_category,src_priority)`\
`risk_score_system("medium","low",dest_system,src_category,src_priority)`

[Threat - RR - System Information Discovery - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - System Information Discovery - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 37 * * * *
schedule_window = 5
description = Suspicious commands used to discover system information
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = index=botsv2 sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" (process="net.exe" OR process="whoami.exe") cmdline="*"\
| table process, parent_process,dvc_ip,user,cmdline,_time\
\
| rename dvc_ip as src_ip\
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_system\
| eval src_system=coalesce(src_system,src_ip)\
\
| eval src_user=mvindex(split(user,"\\"),1)\
\
|eval rule_attack_tactic_technique=\
"discovery - T1082 - System Information Discovery - https://attack.mitre.org/techniques/T1082/" \
\
|eval risk_message="A command was found that is associated with discovering system information, cmd=".cmdline\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_user(impact,confidence,src_user)`

[Threat - RR - Threat Intel File Activity - System - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Threat Intel File Activity - System
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 39 * * * *
schedule_window = 5
description = This search utilizes the threat intel file collection for matches on suspicious files executing.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = | from datamodel:"Threat_Intelligence"."Threat_Activity" \
| search threat_collection="file"\
| table src, dest, threat_match_field, threat_match_value,_time\
\
| rename src as src_ip, dest as dest_ip\
| lookup dnslookup clientip as dest_ip OUTPUT clienthost as dest_dns\
| eval dest_system=coalesce(dest_dns,dest_ip) \
| lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp\
| join type=left src_ip \
    [| inputlookup frothly_assets \
    | fields ip dns \
    | rename ip as src_ip, dns as src_dns\
        ]\
| eval src_system=coalesce(src_dhcp,src_dns,src_ip)\
\
\
|eval rule_attack_tactic_technique=\
"execution - T1204 - User Execution - https://attack.mitre.org/techniques/T1204/" \
\
|eval risk_message="A potentially malicious file (".threat_match_value.") was found connecting within the environment."\
\
|eval TESTMODE=0\
| eval impact="medium"\
| eval confidence="high"\
| eval src_category="", src_priority=""\
`risk_score_system(impact,confidence,src_system,src_category,src_priority)`\
`risk_score_system(impact,confidence,dest_system,src_category,src_priority)`

[Threat - RR - User Account Changes - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - User Account Changes - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 41 * * * *
schedule_window = 5
description = Local user account changes were identified and may indicate compromise.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
schedule_window = auto
search = | tstats summariesonly=true count from datamodel=Change_Analysis.All_Changes where nodename=All_Changes.Account_Management groupby _time span=1s All_Changes.vendor_product All_Changes.dest All_Changes.user All_Changes.src All_Changes.action All_Changes.status All_Changes.dvc All_Changes.Account_Management.src_user All_Changes.object All_Changes.object_category All_Changes.result All_Changes.result_id \
| `drop_dm_object_name("All_Changes")` \
| `drop_dm_object_name("Account_Management")` \
| join type=left dest \
    [| `assets` \
    | table ip, dns \
    | rename ip as dest_ip, dns as dest\
        ] \
| table _time vendor_product result_id result status user src_user action dest_ip object object_category dest\
\
|eval rule_attack_tactic_technique=\
"credential_access - T1098 - Account Manipulation - https://attack.mitre.org/techniques/T1098/" \
\
|eval risk_message="A local account change was identified, ".result." target account=".user\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,dest,src_category,src_priority)`\
`risk_score_user(impact,confidence,src_user)`

[Threat - RR - Potential Phish With Attachment - User - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Potential Phish With Attachment - User
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 41 * * * *
schedule_window = 5
description = Identifies potential phishing emails with an attachment and then applies risk to the user receiving the email.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | from datamodel:Email.All_Email \
| search (file_name="*.zip" OR file_name="*.doc" OR file_name="*.xls" OR file_name="*.docm" OR file_name="*.xlsm") \
| eval action=if((action="delivered") AND (action!="quarantine"),"Delivered", "Not Delivered") \
| stats count as message_count, count(eval(action="Not Delivered")) as blocked_messages, count(eval(action="Delivered")) as allowed_messages, values(file_name) as file_name, values(file_hash) as file_hash, values(recipient) as recipient, values(src_user) as sender, max(_time) as last_sent, min(_time) as first_sent by subject \
| eval difference=last_sent-first_sent \
| eval blocked_rate=blocked_messages/message_count \
| mvexpand recipient \
| join type=left recipient \
    [| from datamodel:"Identity_Management.All_Identities" \
    |search email="*froth.ly"\
    | fields email,identity \
    | mvexpand identity \
    | where like(identity,"%frothly\\%") \
    | eval identity=mvindex(split(identity,"\\"),1) \
    | rename email as recipient, identity as src_user]\
\
|eval rule_attack_tactic_technique=\
"initial_access - T1193 - Spearphishing Attachment - https://attack.mitre.org/techniques/T1193/" \
\
|eval risk_message="A potential spearphishing email was sent to ".src_user." with an attachment, ".file_name.", from  ".sender\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_user(impact,confidence,src_user)`

[RBA:  Threat - RIR - 24 hour risk threshold exceeded - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RIR - 24 hour risk threshold exceeded
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.drilldown_name = View the individual Risk Attributions
action.notable.param.drilldown_search = |from datamodel:"Risk.All_Risk"|search risk_object=$risk_object$ source="Threat*"|table _time risk_object risk_object_type risk_message source risk_score rule_attack_tactic_technique |eventstats sum(risk_score) as risk_scoreSum by risk_object
action.notable.param.extract_artifacts = {"asset": ["src", "dest", "dvc", "orig_host"], "identity": ["src_user", "user"]}
action.notable.param.extract_assets = 
action.notable.param.extract_identities = 
action.notable.param.next_steps = {"version":1,"data":"View the above Contributing Events which will show you the risk attributions."}
action.notable.param.rule_description = RBA:  Risk Threshold Exceeded for an object over a 24 hour period
action.notable.param.rule_title = RBA:  24 hour risk threshold exceeded for $risk_object_type$=$risk_object$ spanning $sourceCount$ Risk Rules, $tacticCount$, ATT&CK tactics, and $techniqueCount$ ATT&CK techniques
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = sourceCount,tacticCount,techniqueCount,risk_object
alert.suppress.period = 21600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = RBA: Risk Threshold exceeded for an object within the previous 24 hours.
disabled = 1
dispatch.earliest_time = -24h
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
realtime_schedule = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | from datamodel:"Risk.All_Risk" \
| search source="Threat - RR*" \
| table _time, risk_object risk_object_type risk_message source risk_score rule_attack_tactic_technique \
| makemv delim="|" rule_attack_tactic_technique \
| mvexpand rule_attack_tactic_technique \
| rex field=rule_attack_tactic_technique "(^|\|)(?<tactic>.+?) - (?<tactic_num>.+?) - (?<technique>.+?) - (?<technique_ref>.*)" \
| streamstats reset_after="("max_time-min_time>86400")" sum(risk_score) as risk_ScoreSum \
    min(_time) as min_time\
    max(_time) as max_time\
    dc(source) as sourceCount \
    dc(tactic) as tacticCount \
    dc(technique) as techniqueCount\
    by risk_object,risk_object_type \
| stats sum(risk_score) as risk_ScoreSum \
    values(risk_message) as risk_message \
    min(min_time) as min_time\
    max(sourceCount) as sourceCount \
    values(source) as source \
    values(rule_attack_tactic_technique) as rule_attack_tactic_technique \
    max(tacticCount) as tacticCount \
    values(tactic) as tactic \
    max(techniqueCount) as techniqueCount\
    values(technique) as technique\
    by risk_object,risk_object_type,max_time \
| eval risk_duration=max_time-min_time \
| where risk_ScoreSum > 100 and risk_duration<86400 \
| eval risk_duration=tostring(risk_duration,"duration")\
| eval severity=case(risk_ScoreSum>=100 and risk_ScoreSum<250,"medium",\
    risk_ScoreSum>=250 and risk_ScoreSum <500,"high",\
    risk_ScoreSum>=500,"critical") \
| eval message="24 hour risk threshold exceeded for ".risk_object_type."=".risk_object." spanning ".sourceCount." Risk Rules, ".tacticCount." ATT&CK tactics, and ".techniqueCount." ATT&CK techniques"\


[RBA:  Threat - RIR - 7 day ATT&CK Tactic threshold exceeded - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RIR - 7 day ATT&CK Tactic threshold exceeded
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable = 1
action.notable.param.drilldown_name = View the individual Risk Attributions
action.notable.param.drilldown_search = |from datamodel:"Risk.All_Risk"|search risk_object=$risk_object$ source="Threat*" |table _time risk_object risk_object_type risk_message source risk_score rule_attack_tactic_technique |eventstats sum(risk_score) as risk_scoreSum by risk_object
action.notable.param.extract_artifacts = {"asset": ["src", "dest", "dvc", "orig_host"], "identity": ["src_user", "user"]}
action.notable.param.extract_assets = 
action.notable.param.extract_identities = 
action.notable.param.next_steps = {"version":1,"data":"View the above Contributing Events which will show you the risk attributions.\n"}
action.notable.param.rule_description = RBA:  ATT&CK tactic Threshold Exceeded for an object over the previous 7 days
action.notable.param.rule_title = RBA:  ATT&CK Tactic threshold exceeded (>=3) over previous 7 days for $risk_object_type$=$risk_object$ spanning $sourceCount$ Risk Rules, $tacticCount$ ATT&CK tactics, and $techniqueCount$ ATT&CK techniques
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
alert.suppress = 1
alert.suppress.fields = sourceCount,tacticCount,techniqueCount,risk_object
alert.suppress.period = 21600s
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = RBA:  ATT&CK tactic Threshold exceeded for an object within the previous 7 days.
disabled = 1
dispatch.earliest_time = -7d
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = | from datamodel:"Risk.All_Risk" \
| search source="Threat - RR*" \
| table _time, risk_object risk_object_type risk_message source risk_score rule_attack_tactic_technique \
| makemv delim="|" rule_attack_tactic_technique \
| mvexpand rule_attack_tactic_technique \
| rex field=rule_attack_tactic_technique "(^|\|)(?<tactic>.+?) - (?<tactic_num>.+?) - (?<technique>.+?) - (?<technique_ref>.*)" \
| streamstats reset_after="("max_time-min_time>604800")" sum(risk_score) as risk_ScoreSum \
    min(_time) as min_time\
    max(_time) as max_time\
    dc(source) as sourceCount \
    dc(tactic) as tacticCount \
    dc(technique) as techniqueCount\
    by risk_object,risk_object_type \
| stats sum(risk_score) as risk_ScoreSum \
    values(risk_message) as risk_message \
    min(min_time) as min_time\
    max(sourceCount) as sourceCount \
    values(source) as source \
    values(rule_attack_tactic_technique) as rule_attack_tactic_technique \
    max(tacticCount) as tacticCount \
    values(tactic) as tactic \
    max(techniqueCount) as techniqueCount\
    values(technique) as technique\
    by risk_object,risk_object_type,max_time \
| eval risk_duration=max_time-min_time \
| where tacticCount >=3 and sourceCount >=4 and risk_duration < 604800 \
| eval risk_duration=tostring(risk_duration,"duration") \
| eval severity=case(risk_ScoreSum>=100 and risk_ScoreSum<250,"medium",\
    risk_ScoreSum>=250 and risk_ScoreSum <500,"high",\
    risk_ScoreSum>=500,"critical") \
| eval message="ATT&CT Tactic threshold exceeded (>=3) over previous 7 days for ".risk_object_type."=".risk_object." spanning ".sourceCount." Risk Rules, ".tacticCount." ATT&CK tactics, and ".techniqueCount." ATT&CK techniques"

[Threat - RR - Command and Control Activity Detected - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Command and Control Activity Detected - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 43 * * * *
schedule_window = 5
description = A network connection was made to a risky host which has exhibited malicious activity and detected by Windows Defender.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=CommandAndControl\
|table _time,MachineName,UserName,CommandLine,Description,FileHash,FileName,FilePath,LogOnUsers,IpAddress,Url\
|eval rule_attack_tactic_technique="Command and Control - TA0011 - Standard Application Layer Protocol - https://attack.mitre.org/techniques/T1071/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=Description." CommandLine=".CommandLine.". LoggedOnUsers=".LogOnUsers." Remote IP=".IpAddress.". URL=".Url\
\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Credential Theft Tool Detected - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Credential Theft Tool Detected - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 45 * * * *
schedule_window = 5
description = A known credential theft tool execution command line was detected by Windows Defender. Either the process itself or its command line indicated an intent to dump users' credentials, keys, plain-text passwords and more.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=CredentialAccess\
|table _time,MachineName,UserName,CommandLine,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Credential Access - TA0006 - Credential Dumping - https://attack.mitre.org/techniques/T1003/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=Description."FilePath=".FilePath." CommandLine=".CommandLine.". LoggedOnUsers=".LogOnUsers." FileHash=".FileHash\
\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE="0"\
| eval impact="high"\
| eval confidence="high"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Discovery tool or technique detected  - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Discovery tool or technique detected  - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 47 * * * *
schedule_window = 5
description = A discovery tool or technique was detected by Windows defender.  An example function would connect to Microsoft Exchange using Exchange Web Services and can be used to gather the current user's mail folders or search the user's mailbox.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=Discovery\
|table _time,MachineName,UserName,CommandLine,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Discovery - TA0007 - Account Discovery - https://attack.mitre.org/techniques/T1087/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=Description."FilePath=".FilePath." CommandLine=".CommandLine.". LoggedOnUsers=".LogOnUsers." FileHash=".FileHash\
\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE="0"\
| eval impact="medium"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Suspisious Process or DLL detected - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspisious Process or DLL detected - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 49 * * * *
schedule_window = 5
description = Windows Defender detected process abnormally injecting code into another process or suspicious memory allocation patterns, As a result, unexpected code may be running in the target process memory. Injection is often used to hide malicious code execution within a trusted process. \
As a result, the target process may exhibit abnormal behaviors such as opening a listening port or connecting to a command and control server.  Pentesting frameworks, like Metasploit, reflectively load the meterpreter dll, which provides an attacker with backdoor access to the machine.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=DefenseEvasion\
|table _time,MachineName,UserName,CommandLine,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Defense Evasion - TA0005 - Process Injection - https://attack.mitre.org/techniques/T1055/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=Description."FilePath=".FilePath." CommandLine=".CommandLine.". LoggedOnUsers=".LogOnUsers." FileHash=".FileHash\
\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE="0"\
| eval impact="high"\
| eval confidence="high"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Suspicious activity or known framework detected  - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious activity or known framework detected  - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 51 * * * *
schedule_window = 5
description = RR - Suspicious activity or known framework detected  - Combined
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=Execution\
|table _time,MachineName,UserName,CommandLine,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Execution - TA0002 - Command Line Interface - https://attack.mitre.org/techniques/T1059/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=Description."FilePath=".FilePath." CommandLine=".CommandLine.". LoggedOnUsers=".LogOnUsers." FileHash=".FileHash\
\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE=0\
| eval impact="medium"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Malware detected by Windows Defender  - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Malware detected by Windows Defender  - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 53 * * * *
schedule_window = 5
description = Malware and unwanted software are undesirable applications that perform annoying, disruptive, or harmful actions on affected machines. Some of these undesirable applications can replicate and spread from one machine to another. Others are able to receive commands from remote attackers and perform activities associated with cyber attacks.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=Malware\
|table _time,MachineName,UserName,CommandLine,AlertTitle,Description,FileHash,FileName,FilePath,LogOnUsers,ThreatCategory,ThreatFamily,ThreatName\
|eval rule_attack_tactic_technique="Execution - TA0002 - Command Line Interface - https://attack.mitre.org/techniques/T1059/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=AlertTitle." ThreatCategory=".ThreatCategory." ThreatFamily=".ThreatFamily." ThreatName=".ThreatName." FilePath=".FilePath." CommandLine=".CommandLine." LoggedOnUsers=".LogOnUsers." FileHash=".FileHash\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE="0"\
| eval impact="high"\
| eval confidence="high"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Suspicious service or registry change detected  - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious service or registry change detected  - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 7 * * * *
schedule_window = 5
description = A system program was registered as a service or a suspicious registry change was detected by Windows Defender. This can indicate malicious intent to establish persistence or gain system privileges.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=Persistence\
|table _time,MachineName,UserName,CommandLine,AlertTitle,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Persistence - TA0003 - Modify Existing Service - https://attack.mitre.org/techniques/T1031/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=AlertTitle.". ".Description." FilePath=".FilePath." CommandLine=".CommandLine." LoggedOnUsers=".LogOnUsers." FileHash=".FileHash\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE="0"\
| eval impact="medium"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Suspicious activity related to escalation of privs has been detected - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious activity related to escalation of privs has been detected - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 9 * * * *
schedule_window = 5
description = Suspicious named pipes or process interaction that typically involves a UAC prompt has been detected. Attackers leverage named pipes for command-and-control, inter-process communication, and data exfiltration. This type of activity is unusual and suspicious and could be an attempt to elevate privileges without requesting user permission.  Detected by Windows Defender.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=PrivilegeEscalation\
|table _time,MachineName,UserName,CommandLine,AlertTitle,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Privilege Escalation - TA0004 - Bypass User Account Control - https://attack.mitre.org/techniques/T1088/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval CommandLine=if(len(CommandLine)>100,substr(CommandLine,1,100)."..<cut>",CommandLine)\
|eval risk_message=AlertTitle.". ".Description." FilePath=".FilePath." CommandLine=".CommandLine." LoggedOnUsers=".LogOnUsers." FileHash=".FileHash\
\
|dedup _time\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE="0"\
| eval impact="medium"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Suspicious CLI command - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious CLI command - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 11 * * * *
schedule_window = 5
description = Suspicious commands being detected by Windows Defender.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=SuspiciousActivity\
|table _time,MachineName,UserName,CommandLine,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Execution - TA0002 - CommandLine Interface - https://attack.mitre.org/techniques/T1059/"\
|eval risk_message=Description." CommandLine=".CommandLine.". LoggedOnUsers=".LogOnUsers\
|dedup _time,risk_message\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/THIRSTYBERNER\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="medium"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`

[Threat - RR - Suspicious CLI command related to information gathering - Combined - Rule]
action.correlationsearch.enabled = 1
action.correlationsearch.label = RR - Suspicious CLI command related to information gathering - Combined
action.customsearchbuilder.enabled = false
action.customsearchbuilder.spec = {}
action.notable.param.verbose = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = 13 * * * *
schedule_window = 5
description = Commands are being executed that can be used by attackers in order to identify assets of value and coordinate lateral movement after compromising a machine.
disabled = 1
dispatch.earliest_time = -1h@h
dispatch.latest_time = @h
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=botsv4 sourcetype=wdtap:alerts Category=Collection\
|table _time,MachineName,UserName,CommandLine,Description,FileHash,FileName,FilePath,LogOnUsers\
|eval rule_attack_tactic_technique="Collection - TA0009 - Automated Collection - https://attack.mitre.org/techniques/T1119/"\
|eval CommandLine=if(CommandLine="",FilePath.FileName,CommandLine)\
|eval risk_message=Description." CommandLine=".CommandLine.". LoggedOnUsers=".LogOnUsers\
|dedup _time,risk_message\
|makemv delim=";" LogOnUsers\
|mvexpand LogOnUsers\
|rex field=LogOnUsers mode=sed "s/.*\\\\//g"\
|rename LogOnUsers as user\
|rename MachineName as src\
\
|eval TESTMODE=0\
| eval impact="low"\
| eval confidence="low"\
`risk_score_system(impact,confidence,src,src_category,src_priority)`\
`risk_score_user(impact,confidence,user)`
