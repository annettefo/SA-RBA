search_name,drilldown_search
Threat - RR - Prohibited Process Detected - System - Rule,"| from datamodel:""Endpoint"".""Processes"" |search _time < 1501848000 host=""REPLACEME"" |lookup interesting_processes_lookup app as process,dest OUTPUTNEW is_required,is_prohibited,is_secure,note | fillnull value=""undefined"" is_required,is_prohibited,is_secure |`lower(is_required)` |`lower(is_prohibited)` |`lower(is_secure)` | search is_prohibited=true"
Threat - RR - DDNS Activity Detected - System - Rule,"| from datamodel:Network_Resolution.DNS | search _time < 1501848000 record_type=""A"" `Exclude_DNS_Server_src_ip` |lookup dhcpLogs dest_ip as src OUTPUT dest_nt_host as host |search host=""REPLACEME"" | eval list=""iana"" | `ut_parse(query,list)` | lookup DDNS_lookup domain as ut_domain | search provider=*"
Threat - RR - DNS Activity to External IP Detected - System - Rule,"| from datamodel:Network_Traffic |search dest_port=53 src_ip!=TERM(10.0.1.100) dest_ip!=TERM(10.0.1.100) dest_ip!=TERM(8.8.8.8) dest_ip!=TERM(4.4.4.4) dest_ip!=TERM(172.31.0.2) |lookup frothly_assets ip as src_ip |search nt_host=""REPLACEME"""
Threat - RR - Process Discrepancy Detected - System - Rule,"search index=botsv2 sourcetype=osquery_results columns.cwd=""/Users*"" host=""REPLACEME"" | rename columns.name as name, columns.cmdline as cmdline | eval dest=host, result=if(like(cmdline,""%"".name.""%""),""Normal"",""Evil"") |search result=""Evil"""
Threat - RR - Threat Intel Match on DNS Domain request - System - Rule,"| from datamodel:Network_Resolution.DNS | search _time < 1501848001 record_type=""A"" `Exclude_DNS_Server_src_ip` | eval list=""iana"" | `ut_parse(query,list)` | lookup local_domain_intel domain as ut_domain OUTPUT description | search description=* | lookup dhcpLogs dest_ip as src OUTPUT dest_nt_host as host |search host=""REPLACEME"""
Threat - RR - USB Insertion with 1st time seen Serial Number - Combined - Rule,"search index=""botsv2"" sourcetype=osquery_results TERM(USB) name=""pack_hardware-monitoring_usb_devices"" action=""added"" (host=""REPLACEME"" OR user=""REPLACEME"")"
Threat - RR - USB Insertion with 1st time seen Vendor ID - Combined - Rule,"search index=""botsv2"" sourcetype=osquery_results TERM(USB) name=""pack_hardware-monitoring_usb_devices"" action=""added"" (host=""REPLACEME"" OR user=""REPLACEME"")"
Threat - RR - DNS Query For Potential DGA Domain - System - Rule,"|from datamodel:Network_Resolution.DNS | search record_type=A [| search index=risk source=""Threat - RR - DNS Query For Potential DGA Domain - System - Rule"" risk_object=""REPLACEME"" | fields src_ip,dest_system | dedup src_ip,dest_system | eval dest_system=""*."".dest_system | rename src_ip as src, dest_system as query] | mvexpand query | eval list=""*"" | `ut_parse_extended(query,list)` | lookup dns_exclusions.csv domain AS ut_domain OUTPUT domain | search NOT(ut_domain=""None"" OR domain=*) | lookup alexa_lookup_by_str domain AS ut_domain | search NOT(rank=*) | `ut_shannon(ut_subdomain)` | eval subdomain_length=len(tostring(ut_subdomain)) | convert num(ut_shannon) as ut_shannon | where ut_shannon>3 and subdomain_length>20"
Threat - RR - Intrusion Detection Event - System - Rule,"|from datamodel:Intrusion_Detection.IDS_Attacks | search signature!=""unknown"" [| search index=risk source=""Threat - RR - Intrusion Detection Event - System - Rule"" risk_object=""REPLACEME"" | fields src_ip | dedup src_ip | rename src_ip as src] | rex field=_raw ""dest_ip.:.(?<dest_ip>[^\""]*?)\"".*?dest_port.:(?<dest_port>\d+).*payload.:.(?<payload>[^\""]*)\"""""
Threat - RR - Long Network Connection - System - Rule,"| from datamodel:Network_Traffic.All_Traffic | search duration>10800 [| search index=risk source=""Threat - RR - Long Network Connection - System - Rule"" risk_object=""REPLACEME"" | fields src_ip,dest_ip | dedup src_ip,dest_ip]"
Threat - RR - Non-Standard Port Web Traffic - System - Rule,"|from datamodel:Web.Web | search src=""10.*"" dest!=""10.*"" | eval list=""mozilla"" | `ut_parse_extended(url,list)` | where ut_port!=""80"" AND ut_port!=""443"" | rename src as src_ip, dest as dest_ip | lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp | lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp | join type=left src_ip [| inputlookup frothly_assets | fields ip dns | rename ip as src_ip, dns as src_dns ] | lookup dnslookup clientip as dest_ip OUTPUT clienthost as dest_dns | eval dest_system=coalesce(dest_dns,dest_ip) | eval src_system=coalesce(src_dhcp,src_dns,src_ip) |search src_system=""REPLACEME"""
Threat - RR - Security Control Disabled - Combined - Rule,"search index=botsv2 sourcetype=""XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"" cmdline=""*netsh.exe*"" cmdline=""*off*"" | rename dvc_ip as src_ip | lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp | join type=left src_ip [| inputlookup frothly_assets | fields ip dns | rename ip as src_ip, dns as src_dns ] | eval src_system=coalesce(src_dhcp,src_dns,src_ip) | eval src_user=mvindex(split(user,""\\""),1) |search src_system=""REPLACEME"" OR src_user=""REPLACEME"""
Threat - RR - Suspicious Developer Utility Command - Combined - Rule,"search index=botsv2 sourcetype=""XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"" cmdline=""*csc.exe*/noconfig*"" | rename dvc_ip as src_ip | lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp | join type=left src_ip [| inputlookup frothly_assets | fields ip dns | rename ip as src_ip, dns as src_dns ] | eval src_system=coalesce(src_dhcp,src_dns,src_ip) | eval src_user=mvindex(split(user,""\\""),1) |search src_system=""REPLACEME"" OR src_user=""REPLACEME"""
Threat - RR - Suspicious PowerShell Command - Combined - Rule,"search index=botsv2 sourcetype=""XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"" cmdline=""*powershell*-nop*"" | rename dvc_ip as src_ip | lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp | join type=left src_ip [| inputlookup frothly_assets | fields ip dns | rename ip as src_ip, dns as src_dns ] | eval src_system=coalesce(src_dhcp,src_dns,src_ip) | eval src_user=mvindex(split(user,""\\""),1) |search src_system=""REPLACEME"" OR src_user=""REPLACEME"""
Threat - RR - Suspicious Scheduled Task - Combined - Rule,"search index=botsv2 sourcetype=""XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"" process=""schtasks.exe"" cmdline=""*-w hidden*"" | rename dvc_ip as src_ip | lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp | join type=left src_ip [| inputlookup frothly_assets | fields ip dns | rename ip as src_ip, dns as src_dns ] | eval src_system=coalesce(src_dhcp,src_dns,src_ip) | eval src_user=mvindex(split(user,""\\""),1) |search src_system=""REPLACEME"" OR src_user=""REPLACEME"""
Threat - RR - Suspicious SSL Certificate - System - Rule,"|from datamodel:Certificates.SSL | search ssl_subject!=""*CN \=*"" ssl_subject!=""*O \=*""[|search index=risk source=""Threat - RR - Suspicious SSL Certificate - System - Rule"" risk_object=""REPLACEME""|fields src_ip,dest_ip|dedup src_ip,dest_ip|rename src_ip as src, dest_ip as dest]"
Threat - RR - System Information Discovery - Combined - Rule,"index=botsv2 sourcetype=""XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"" (process=""net.exe"" OR process=""whoami.exe"") cmdline=""*""|rename dvc_ip as src_ip|lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_system|eval src_system=coalesce(src_system,src_ip)| eval src_user=mvindex(split(user,""\\""),1)|search src_user=""REPLACEME"" OR src_system=""REPLACEME"""
Threat - RR - Threat Intel File Activity - System - Rule,"|from datamodel:""Threat_Intelligence"".""Threat_Activity"" | search threat_collection=""file"" | rename src as src_ip, dest as dest_ip | lookup dnslookup clientip as dest_ip OUTPUT clienthost as dest_dns | eval dest_system=coalesce(dest_dns,dest_ip) | lookup dhcpLogs dest_ip as src_ip OUTPUT dest_nt_host as src_dhcp | join type=left src_ip [| inputlookup frothly_assets | fields ip dns | rename ip as src_ip, dns as src_dns ] | eval src_system=coalesce(src_dhcp,src_dns,src_ip) |search src_system=""REPLACEME"" OR dest_system=""REPLACEME"""
Threat - RR - User Account Changes - Combined - Rule,"|from datamodel:Change_Analysis.All_Changes|search tag=""account"" host=""wrk-btun""|rex max_match=0 ""Account Name:\W+(?<user>(.+))""|search user=""REPLACEME"" OR dest=""REPLACEME"""
Threat - RR - Potential Phish With Attachment - User - Rule,"| from datamodel:Email.All_Email| search (file_name=""*.zip"" OR file_name=""*.doc"" OR file_name=""*.xls"" OR file_name=""*.docm"" OR file_name=""*.xlsm"")|mvexpand recipient|join type=left recipient [|from datamodel:""Identity_Management.All_Identities""|search email=""*froth.ly""|fields email,identity|mvexpand identity|where like(identity,""%frothly\\%"")|eval identity=mvindex(split(identity,""\\""),1)|rename email as recipient, identity as src_user]|search src_user=REPLACEME"
